name: Update OpenApi Schema
run-name: ${{ github.actor }} is updating OpenApi Schema

on:
    push:
        branches:
            - master
    pull_request:
        branches:
            - master
jobs:
    update-openapi-schema:
        runs-on: ubuntu-latest
        services:
            postgres:
                image: postgres
                env:
                    POSTGRES_DB: backend_ci
                    POSTGRES_USER: ci
                    POSTGRES_PASSWORD: password
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432
        steps:
            - name: Checkout
              uses: actions/checkout@v2
            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.3"
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
                  coverage: none
            - name: Install Composer packages
              working-directory: ./backend
              run: composer install -n --prefer-dist
            - name: Prepare Laravel Application
              working-directory: ./backend
              run: |
                  cp .env.ci .env
                  php artisan key:generate
            - name: Run Database Migrations
              working-directory: ./backend
              run: php artisan migrate --force
            - name: Generate OpenApi Schema
              working-directory: ./backend
              run: php artisan openapi:generate
